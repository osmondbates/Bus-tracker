<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SF MUNI Bus Tracker</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        h1 {
            color: #0066cc;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .bus-stop {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .stop-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #0066cc;
        }
        
        .stop-id {
            background-color: #0066cc;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .arrivals {
            width: 100%;
            border-collapse: collapse;
        }
        
        .arrivals th {
            text-align: left;
            padding: 8px;
            background-color: #f5f5f5;
        }
        
        .arrivals td {
            padding: 8px;
            border-top: 1px solid #eee;
        }
        
        .route {
            font-weight: bold;
            background-color: #0066cc;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
            width: 40px;
            text-align: center;
        }
        
        .countdown {
            font-weight: bold;
        }
        
        .no-arrivals {
            color: #999;
            font-style: italic;
            padding: 10px 0;
        }
        
        .last-updated {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 0.9em;
        }
        
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        
        .error {
            background-color: #ffeeee;
            color: #cc0000;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .bus-stop {
                padding: 10px;
            }
            
            .arrivals th, .arrivals td {
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <h1>SF MUNI Bus Tracker</h1>
    <div id="error" class="error" style="display: none;"></div>
    <div id="loading" class="loading">Loading bus arrival times...</div>
    <div id="stops-container"></div>
    <div class="last-updated">Last updated: <span id="update-time"></span></div>

    <script>
        // Configuration
        const API_KEY = c9b7f6c6-5dc7-409e-9ea5-e835b086a409; // Replace with your actual 511.org API key
        const STOPS = [
            {id: "13333", name: "Loading..."},
            {id: "13334", name: "Loading..."},
            {id: "15558", name: "Loading..."},
            {id: "15557", name: "Loading..."},
            {id: "13471", name: "Loading..."},
            {id: "13472", name: "Loading..."},
            {id: "16216", name: "Loading..."},
            {id: "16217", name: "Loading..."}
        ];
        const REFRESH_INTERVAL = 60000; // 1 minute in milliseconds
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            createStopContainers();
            fetchAllStopData();
            
            // Set up auto-refresh
            setInterval(fetchAllStopData, REFRESH_INTERVAL);
        });
        
        // Create containers for each stop
        function createStopContainers() {
            const container = document.getElementById('stops-container');
            
            STOPS.forEach(stop => {
                const stopElement = document.createElement('div');
                stopElement.className = 'bus-stop';
                stopElement.id = `stop-${stop.id}`;
                
                const header = document.createElement('div');
                header.className = 'stop-header';
                
                const nameElement = document.createElement('div');
                nameElement.className = 'stop-name';
                nameElement.textContent = stop.name;
                
                const idElement = document.createElement('div');
                idElement.className = 'stop-id';
                idElement.textContent = `Stop #${stop.id}`;
                
                header.appendChild(nameElement);
                header.appendChild(idElement);
                
                const arrivalsContainer = document.createElement('div');
                arrivalsContainer.className = 'arrivals-container';
                arrivalsContainer.innerHTML = '<p class="loading">Loading arrivals...</p>';
                
                stopElement.appendChild(header);
                stopElement.appendChild(arrivalsContainer);
                container.appendChild(stopElement);
            });
        }
        
        // Fetch data for all stops
        async function fetchAllStopData() {
            const loadingElement = document.getElementById('loading');
            const errorElement = document.getElementById('error');
            
            try {
                loadingElement.style.display = 'block';
                errorElement.style.display = 'none';
                
                // First fetch stop names if we don't have them
                const namePromises = STOPS.map(async stop => {
                    if (stop.name === "Loading...") {
                        try {
                            const stopInfo = await fetchStopInfo(stop.id);
                            stop.name = stopInfo.name;
                            updateStopName(stop.id, stopInfo.name);
                        } catch (error) {
                            console.error(`Error fetching stop info for ${stop.id}:`, error);
                        }
                    }
                });
                
                await Promise.all(namePromises);
                
                // Then fetch arrivals for all stops
                const arrivalPromises = STOPS.map(stop => fetchStopPredictions(stop.id));
                const results = await Promise.all(arrivalPromises);
                
                // Update the timestamp
                const now = new Date();
                document.getElementById('update-time').textContent = now.toLocaleTimeString();
                
                loadingElement.style.display = 'none';
            } catch (error) {
                console.error('Error fetching data:', error);
                errorElement.textContent = `Error fetching data: ${error.message}`;
                errorElement.style.display = 'block';
                loadingElement.style.display = 'none';
            }
        }
        
        // Fetch stop information (name, etc.)
        async function fetchStopInfo(stopId) {
            // In a real implementation, you would call the 511.org API
            // For now, we'll simulate stop names
            const stopNames = {
                "13333": "Market St & 7th St",
                "13334": "Market St & 8th St",
                "15558": "Van Ness Ave & Market St",
                "15557": "Van Ness Ave & Market St",
                "13471": "Mission St & 16th St",
                "13472": "Mission St & 16th St",
                "16216": "Castro St & Market St",
                "16217": "Castro St & Market St"
            };
            
            // Simulate API request delay
            await new Promise(resolve => setTimeout(resolve, 100));
            
            return {
                id: stopId,
                name: stopNames[stopId] || `Stop #${stopId}`
            };
        }
        
        // Update stop name in the UI
        function updateStopName(stopId, name) {
            const stopElement = document.getElementById(`stop-${stopId}`);
            if (stopElement) {
                const nameElement = stopElement.querySelector('.stop-name');
                if (nameElement) {
                    nameElement.textContent = name;
                }
            }
        }
        
        // Fetch predictions for a specific stop
        async function fetchStopPredictions(stopId) {
            try {
                // In a real implementation, you would call the 511.org API endpoint:
                // https://api.511.org/transit/StopMonitoring?api_key={your_key}&agency=SF&stopCode={stopId}
                
                // For demo purposes, we'll simulate the API response with realistic data
                const data = await simulateStopPredictions(stopId);
                
                // Process and display the data
                displayPredictions(stopId, data);
                return data;
            } catch (error) {
                console.error(`Error fetching predictions for stop ${stopId}:`, error);
                displayError(stopId, error.message);
                throw error;
            }
        }
        
        // Simulate stop predictions (for demo purposes)
        async function simulateStopPredictions(stopId) {
            // Simulate network delay
            await new Promise(resolve => setTimeout(resolve, 300));
            
            // Create realistic mock data based on stop ID
            const routes = {
                "13333": ["F", "7", "9"],
                "13334": ["F", "7", "9"],
                "15558": ["49", "9", "J"],
                "15557": ["49", "9", "J"],
                "13471": ["14", "49", "22"],
                "13472": ["14", "49", "22"],
                "16216": ["F", "K", "L"],
                "16217": ["F", "K", "L"]
            };
            
            const destinations = {
                "F": "Fisherman's Wharf",
                "7": "Ortega/48th Ave",
                "9": "Visitacion Valley",
                "14": "Daly City BART",
                "22": "SF State University",
                "49": "City College",
                "J": "Balboa Park",
                "K": "Balboa Park",
                "L": "SF Zoo"
            };
            
            const stopRoutes = routes[stopId] || ["1", "14"];
            const arrivals = [];
            
            // Generate 0-5 arrivals for each route
            stopRoutes.forEach(route => {
                const numArrivals = Math.floor(Math.random() * 3) + 1;
                let lastTime = Math.floor(Math.random() * 5) + 1;
                
                for (let i = 0; i < numArrivals; i++) {
                    arrivals.push({
                        route: route,
                        destination: destinations[route] || "Downtown",
                        minutes: lastTime
                    });
                    lastTime += Math.floor(Math.random() * 10) + 5;
                }
            });
            
            // Sort by arrival time
            arrivals.sort((a, b) => a.minutes - b.minutes);
            
            return arrivals;
        }
        
        // Display predictions in the UI
        function displayPredictions(stopId, predictions) {
            const stopElement = document.getElementById(`stop-${stopId}`);
            if (!stopElement) return;
            
            const arrivalsContainer = stopElement.querySelector('.arrivals-container');
            
            if (predictions.length === 0) {
                arrivalsContainer.innerHTML = '<p class="no-arrivals">No upcoming arrivals</p>';
                return;
            }
            
            let html = `
                <table class="arrivals">
                    <thead>
                        <tr>
                            <th>Route</th>
                            <th>Destination</th>
                            <th>Arriving</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            predictions.forEach(prediction => {
                html += `
                    <tr>
                        <td><span class="route">${prediction.route}</span></td>
                        <td>${prediction.destination}</td>
                        <td class="countdown">${formatArrivalTime(prediction.minutes)}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            arrivalsContainer.innerHTML = html;
        }
        
        // Display error for a specific stop
        function displayError(stopId, message) {
            const stopElement = document.getElementById(`stop-${stopId}`);
            if (!stopElement) return;
            
            const arrivalsContainer = stopElement.querySelector('.arrivals-container');
            arrivalsContainer.innerHTML = `<p class="error">Error: ${message}</p>`;
        }
        
        // Format arrival time in minutes
        function formatArrivalTime(minutes) {
            if (minutes === 0) return "Now";
            if (minutes === 1) return "1 min";
            return `${minutes} mins`;
        }
        
        // Function to implement the actual API call when ready
        async function callRealApi(stopId) {
            const url = `https://api.511.org/transit/StopMonitoring?api_key=${API_KEY}&agency=SF&stopCode=${stopId}&format=json`;
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }
            
            const data = await response.json();
            // Process the actual 511.org API response format
            // This would need to be adjusted based on the actual response structure
            
            // Example processing:
            const arrivals = [];
            const visits = data?.ServiceDelivery?.StopMonitoringDelivery?.MonitoredStopVisit || [];
            
            visits.forEach(visit => {
                const journey = visit.MonitoredVehicleJourney;
                if (journey) {
                    const route = journey.PublishedLineName || "Unknown";
                    const destination = journey.DestinationName || "Unknown";
                    const call = journey.MonitoredCall;
                    
                    if (call && call.ExpectedArrivalTime) {
                        const arrivalTime = new Date(call.ExpectedArrivalTime);
                        const now = new Date();
                        const minutesUntil = Math.floor((arrivalTime - now) / 60000);
                        
                        arrivals.push({
                            route: route,
                            destination: destination,
                            minutes: minutesUntil >= 0 ? minutesUntil : 0
                        });
                    }
                }
            });
            
            return arrivals;
        }
    </script>
</body>
</html>
