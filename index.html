<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SF MUNI Bus Tracker</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f7f7f7;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
        }
        h1 {
            color: #0066cc;
            margin-top: 0;
            font-size: 1.5rem;
        }
        .bus-stops {
            margin-top: 20px;
        }
        .stop {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }
        .stop:last-child {
            border-bottom: none;
        }
        .stop-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .arrival {
            display: flex;
            align-items: center;
            margin: 5px 0;
            padding: 8px;
            background-color: #f3f3f3;
            border-radius: 4px;
        }
        .bus-number {
            background-color: #0066cc;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            margin-right: 10px;
            font-weight: bold;
        }
        .time {
            font-weight: 500;
        }
        .destination {
            color: #666;
            margin-left: auto;
        }
        .setup-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f7ff;
            border-radius: 6px;
            border-left: 4px solid #0066cc;
        }
        .settings {
            margin-top: 15px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #0066cc;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        button:hover {
            background-color: #0055b3;
        }
        .stop-actions {
            display: flex;
            margin-top: 10px;
            gap: 10px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            color: #d32f2f;
            padding: 10px;
            background-color: #ffebee;
            border-radius: 4px;
            margin: 10px 0;
        }
        .no-arrivals {
            padding: 10px;
            color: #666;
            font-style: italic;
        }
        .refresh-button {
            margin-top: 15px;
            background-color: #4caf50;
        }
        .refresh-button:hover {
            background-color: #388e3c;
        }
        .last-updated {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            text-align: right;
        }
        .muni-logo {
            height: 28px;
            vertical-align: middle;
            margin-right: 8px;
        }
        .header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .route-circles {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .route-circle {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            color: white;
            background-color: #0066cc;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="/api/placeholder/80/28" alt="SF MUNI" class="muni-logo">
            <h1>SF MUNI Bus Tracker</h1>
        </div>
        
        <div id="setup-container" class="setup-section">
            <h2>Setup Your MUNI Tracker</h2>
            <p>Enter your 511.org API key and add the MUNI stops you want to track.</p>
            
            <div class="settings">
                <div class="form-group">
                    <label for="api-key">511.org API Key:</label>
                    <input type="text" id="api-key" placeholder="Enter your API key">
                </div>
                
                <div class="form-group">
                    <label for="stop-id">MUNI Stop ID:</label>
                    <input type="text" id="stop-id" placeholder="Enter MUNI stop ID">
                </div>
                
                <div class="form-group">
                    <label for="stop-name">Stop Name (optional):</label>
                    <input type="text" id="stop-name" placeholder="Enter a name for this stop">
                </div>
                
                <button id="add-stop">Add Stop</button>
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
                <button id="save-settings">Save Settings</button>
                <button id="edit-settings" style="display: none; background-color: #757575;">Edit Settings</button>
            </div>
        </div>
        
        <div id="bus-stops" class="bus-stops" style="display: none;">
            <div id="loading" class="loading">Loading MUNI arrival information...</div>
            <button id="refresh-data" class="refresh-button" style="display: none;">Refresh Data</button>
            <div id="last-updated" class="last-updated"></div>
        </div>
    </div>

    <script>
        // Store stops and API key
        let busStops = [];
        let apiKey = '';
        let refreshInterval;
        
        // DOM elements
        const setupContainer = document.getElementById('setup-container');
        const busStopsContainer = document.getElementById('bus-stops');
        const loadingElement = document.getElementById('loading');
        const apiKeyInput = document.getElementById('api-key');
        const stopIdInput = document.getElementById('stop-id');
        const stopNameInput = document.getElementById('stop-name');
        const addStopButton = document.getElementById('add-stop');
        const saveSettingsButton = document.getElementById('save-settings');
        const editSettingsButton = document.getElementById('edit-settings');
        const refreshButton = document.getElementById('refresh-data');
        const lastUpdatedElement = document.getElementById('last-updated');
        
        // MUNI agency code
        const MUNI_AGENCY = 'SF';
        
        // Load saved settings if available
        function loadSettings() {
            const savedSettings = localStorage.getItem('muniTrackerSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                apiKey = settings.apiKey || '';
                busStops = settings.stops || [];
                
                apiKeyInput.value = apiKey;
                
                if (apiKey && busStops.length > 0) {
                    setupContainer.style.display = 'none';
                    busStopsContainer.style.display = 'block';
                    editSettingsButton.style.display = 'block';
                    refreshButton.style.display = 'block';
                    fetchAllBusArrivals();
                    
                    // Set up auto-refresh every 60 seconds
                    refreshInterval = setInterval(fetchAllBusArrivals, 60000);
                }
            }
        }
        
        // Save settings to localStorage
        function saveSettings() {
            apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) {
                showError('Please enter your 511.org API key');
                return;
            }
            
            if (busStops.length === 0) {
                showError('Please add at least one MUNI stop');
                return;
            }
            
            const settings = {
                apiKey,
                stops: busStops
            };
            
            localStorage.setItem('muniTrackerSettings', JSON.stringify(settings));
            
            setupContainer.style.display = 'none';
            busStopsContainer.style.display = 'block';
            editSettingsButton.style.display = 'block';
            refreshButton.style.display = 'block';
            
            fetchAllBusArrivals();
            
            // Set up auto-refresh every 60 seconds
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            refreshInterval = setInterval(fetchAllBusArrivals, 60000);
        }
        
        // Add a new stop to the list
        function addStop() {
            const stopId = stopIdInput.value.trim();
            const stopName = stopNameInput.value.trim() || `MUNI Stop ${stopId}`;
            
            if (!stopId) {
                showError('Please enter a MUNI stop ID');
                return;
            }
            
            // Check if stop already exists
            const exists = busStops.some(stop => stop.stopId === stopId);
            
            if (exists) {
                showError('This stop is already in your list');
                return;
            }
            
            busStops.push({
                stopId,
                name: stopName
            });
            
            // Clear inputs
            stopIdInput.value = '';
            stopNameInput.value = '';
            
            showError(`Added stop: ${stopName} (#${stopId})`, 'success');
        }
        
        // Fetch arrivals for all stops
        function fetchAllBusArrivals() {
            // Clear previous results but keep the loading element
            while (busStopsContainer.firstChild) {
                if (busStopsContainer.firstChild !== loadingElement && 
                    busStopsContainer.firstChild !== refreshButton &&
                    busStopsContainer.firstChild !== lastUpdatedElement) {
                    busStopsContainer.removeChild(busStopsContainer.firstChild);
                }
            }
            
            loadingElement.style.display = 'block';
            refreshButton.style.display = 'none';
            
            const promises = busStops.map(stop => fetchBusArrivals(stop));
            
            Promise.all(promises)
                .then(() => {
                    loadingElement.style.display = 'none';
                    refreshButton.style.display = 'block';
                    updateLastUpdatedTime();
                })
                .catch(error => {
                    console.error('Error fetching bus arrivals:', error);
                    showError('Failed to fetch MUNI arrivals. Please check your API key and stop IDs.');
                    loadingElement.style.display = 'none';
                    refreshButton.style.display = 'block';
                });
        }
        
        // Update the last updated time
        function updateLastUpdatedTime() {
            const now = new Date();
            lastUpdatedElement.textContent = `Last updated: ${now.toLocaleTimeString()}`;
        }
        
        // Get route color based on MUNI line
        function getRouteColor(routeName) {
            const routeColors = {
                'J': '#BF9000', // Judah - Gold
                'KT': '#9900CC', // K/T - Purple
                'L': '#A64B00', // Taraval - Brown/Rust
                'M': '#008450', // Ocean View - Green
                'N': '#0072CE', // Judah - Blue
                '1': '#CC0000', // California - Red
                '14': '#CC0000', // Mission - Red
                '22': '#002776', // Fillmore - Navy
                '38': '#CC0000', // Geary - Red
                // Default to MUNI blue for other routes
            };
            
            // Check if the route name starts with any of the keys
            for (const key in routeColors) {
                if (routeName.startsWith(key)) {
                    return routeColors[key];
                }
            }
            
            return '#0066cc'; // Default MUNI blue
        }
        
        // Extract route names from arrivals data
        function extractRoutes(monitoredStopVisits) {
            const routes = new Set();
            monitoredStopVisits.forEach(visit => {
                const lineRef = visit.MonitoredVehicleJourney.LineRef;
                routes.add(lineRef);
            });
            return Array.from(routes);
        }
        
        // Create route circles display
        function createRouteCircles(routes) {
            const routeCirclesElement = document.createElement('div');
            routeCirclesElement.className = 'route-circles';
            
            routes.forEach(route => {
                const routeCircle = document.createElement('div');
                routeCircle.className = 'route-circle';
                routeCircle.textContent = route;
                routeCircle.style.backgroundColor = getRouteColor(route);
                routeCirclesElement.appendChild(routeCircle);
            });
            
            return routeCirclesElement;
        }
        
        // Fetch arrivals for a single stop using 511.org API
        function fetchBusArrivals(stop) {
            return new Promise((resolve, reject) => {
                // Create a stop element
                const stopElement = document.createElement('div');
                stopElement.className = 'stop';
                
                const stopNameElement = document.createElement('div');
                stopNameElement.className = 'stop-name';
                stopNameElement.textContent = stop.name;
                
                stopElement.appendChild(stopNameElement);
                
                // Build the API URL - Fixed to SF MUNI
                const baseUrl = 'https://api.511.org/transit/StopMonitoring';
                const url = `${baseUrl}?api_key=${apiKey}&agency=${MUNI_AGENCY}&stopCode=${stop.stopId}&format=json`;
                
                // Fetch data from 511.org API
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Process the API response
                        const monitoredStopVisits = data?.ServiceDelivery?.StopMonitoringDelivery?.MonitoredStopVisit || [];
                        
                        if (monitoredStopVisits.length === 0) {
                            const noArrivalsElement = document.createElement('div');
                            noArrivalsElement.className = 'no-arrivals';
                            noArrivalsElement.textContent = 'No upcoming arrivals for this stop';
                            stopElement.appendChild(noArrivalsElement);
                        } else {
                            // Extract and display route circles
                            const routes = extractRoutes(monitoredStopVisits);
                            const routeCirclesElement = createRouteCircles(routes);
                            stopElement.appendChild(routeCirclesElement);
                            
                            // Sort arrivals by arrival time
                            const sortedVisits = [...monitoredStopVisits].sort((a, b) => {
                                const timeA = a.MonitoredVehicleJourney.MonitoredCall?.ExpectedArrivalTime || '';
                                const timeB = b.MonitoredVehicleJourney.MonitoredCall?.ExpectedArrivalTime || '';
                                return timeA.localeCompare(timeB);
                            });
                            
                            sortedVisits.forEach(visit => {
                                const monitoredVehicleJourney = visit.MonitoredVehicleJourney;
                                const lineRef = monitoredVehicleJourney.LineRef;
                                const destination = monitoredVehicleJourney.DestinationName;
                                const expectedArrival = monitoredVehicleJourney.MonitoredCall?.ExpectedArrivalTime;
                                
                                // Calculate minutes until arrival
                                let minutesText = 'Unknown';
                                if (expectedArrival) {
                                    const arrivalTime = new Date(expectedArrival);
                                    const now = new Date();
                                    const minutesDiff = Math.floor((arrivalTime - now) / 60000);
                                    
                                    if (minutesDiff <= 0) {
                                        minutesText = 'Arriving now';
                                    } else {
                                        minutesText = `${minutesDiff} min`;
                                    }
                                }
                                
                                // Create arrival element
                                const arrivalElement = document.createElement('div');
                                arrivalElement.className = 'arrival';
                                
                                const busNumberElement = document.createElement('span');
                                busNumberElement.className = 'bus-number';
                                busNumberElement.textContent = lineRef;
                                busNumberElement.style.backgroundColor = getRouteColor(lineRef);
                                
                                const timeElement = document.createElement('span');
                                timeElement.className = 'time';
                                timeElement.textContent = minutesText;
                                
                                const destinationElement = document.createElement('span');
                                destinationElement.className = 'destination';
                                destinationElement.textContent = `To ${destination}`;
                                
                                arrivalElement.appendChild(busNumberElement);
                                arrivalElement.appendChild(timeElement);
                                arrivalElement.appendChild(destinationElement);
                                
                                stopElement.appendChild(arrivalElement);
                            });
                        }
                        
                        // Add "Remove Stop" button
                        const stopActions = document.createElement('div');
                        stopActions.className = 'stop-actions';
                        
                        const removeButton = document.createElement('button');
                        removeButton.textContent = 'Remove';
                        removeButton.style.backgroundColor = '#d32f2f';
                        removeButton.addEventListener('click', () => {
                            const index = busStops.findIndex(s => s.stopId === stop.stopId);
                            if (index !== -1) {
                                busStops.splice(index, 1);
                                stopElement.remove();
                                
                                // Save updated stops
                                const settings = {
                                    apiKey,
                                    stops: busStops
                                };
                                localStorage.setItem('muniTrackerSettings', JSON.stringify(settings));
                                
                                // If no stops left, show setup again
                                if (busStops.length === 0) {
                                    setupContainer.style.display = 'block';
                                    busStopsContainer.style.display = 'none';
                                    editSettingsButton.style.display = 'none';
                                    if (refreshInterval) {
                                        clearInterval(refreshInterval);
                                    }
                                }
                            }
                        });
                        
                        stopActions.appendChild(removeButton);
                        stopElement.appendChild(stopActions);
                        
                        // Insert before the refresh button
                        busStopsContainer.insertBefore(stopElement, refreshButton);
                        resolve();
                    })
                    .catch(error => {
                        console.error(`Error fetching arrivals for stop ${stop.stopId}:`, error);
                        
                        const errorElement = document.createElement('div');
                        errorElement.className = 'error';
                        errorElement.textContent = `Failed to fetch arrivals for ${stop.name}. Please check your API key and stop ID.`;
                        
                        stopElement.appendChild(errorElement);
                        
                        // Add "Remove Stop" button even if there's an error
                        const stopActions = document.createElement('div');
                        stopActions.className = 'stop-actions';
                        
                        const removeButton = document.createElement('button');
                        removeButton.textContent = 'Remove';
                        removeButton.style.backgroundColor = '#d32f2f';
                        removeButton.addEventListener('click', () => {
                            const index = busStops.findIndex(s => s.stopId === stop.stopId);
                            if (index !== -1) {
                                busStops.splice(index, 1);
                                stopElement.remove();
                                
                                // Save updated stops
                                const settings = {
                                    apiKey,
                                    stops: busStops
                                };
                                localStorage.setItem('muniTrackerSettings', JSON.stringify(settings));
                            }
                        });
                        
                        stopActions.appendChild(removeButton);
                        stopElement.appendChild(stopActions);
                        
                        // Insert before the refresh button
                        busStopsContainer.insertBefore(stopElement, refreshButton);
                        resolve(); // Resolve even if there's an error for this stop
                    });
            });
        }
        
        // Show error or success message
        function showError(message, type = 'error') {
            const errorElement = document.createElement('div');
            errorElement.className = type === 'error' ? 'error' : 'error' + ' success';
            errorElement.textContent = message;
            errorElement.style.color = type === 'error' ? '#d32f2f' : '#388e3c';
            errorElement.style.backgroundColor = type === 'error' ? '#ffebee' : '#e8f5e9';
            
            // Find where to insert the error
            const formGroup = document.querySelector('.form-group');
            formGroup.parentNode.insertBefore(errorElement, formGroup);
            
            // Remove after 3 seconds
            setTimeout(() => {
                errorElement.remove();
            }, 3000);
        }
        
        // Event listeners
        addStopButton.addEventListener('click', addStop);
        saveSettingsButton.addEventListener('click', saveSettings);
        refreshButton.addEventListener('click', fetchAllBusArrivals);
        
        editSettingsButton.addEventListener('click', () => {
            setupContainer.style.display = 'block';
            editSettingsButton.style.display = 'none';
            
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
        
        // Initialize
        loadSettings();
    </script>
</body>
</html>
